<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>


<!--  Add the JavaScript to initialize the chart on document ready -->
<script>
    var chart; // global
    var map; // global
    var p; //global
    var marker; //global

    function showHide(idx) {
	if (chart.series[idx].visible) {
	    chart.series[idx].hide();
	    chart.yAxis[idx].visible = false;
	    chart.yAxis[idx].setTitle({text: ''});
	} else {
	    chart.series[idx].show();
	    chart.yAxis[idx].visible = true;
	    if (idx == 0) {chart.yAxis[0].setTitle({text: p.Y0Name})};
	    if (idx == 1) {chart.yAxis[1].setTitle({text: p.Y1Name})};
	    if (idx == 2) {chart.yAxis[2].setTitle({text: p.Y2Name})};
	}
	}

    function moveMarker(evnt){
	// undocumented api function, may change?
	// http://jsfiddle.net/highcharts/K7pN9/
	evt = chart.pointer.normalize(evnt); 	
	point = chart.series[0].searchPoint(evt, true);
	if (point) {
		var moveLatlong = p.Latlongs[point.index];
		marker.setPosition(moveLatlong);
		}
        }

    function createEmptyChart() {

	//
        //Here's a chart object with good defaults for a distance chart.
	//

        newChart = new Highcharts.Chart({
            chart: {
                zoomType: 'xy',
                renderTo: 'container',
                defaultSeriesType: 'spline',
		panning: true,
		panKey: 'shift'
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: false
            },
            title: {
                text: 'Point plot'
            },
            tooltip: {
                shared: true,
		formatter: function () {
		    var s = '<b>' + 'Distance : ' + this.x.toFixed(2) + '</b>';
		    var primaryY = this.points[0];
		    var secondaryY = this.points[1];
		    var tertiaryY = this.points[2];
		    var minutes = primaryY.y;
		    var sign = minutes < 0 ? "-" : "";
		    var min = Math.floor(Math.abs(minutes));
		    var sec = Math.floor((Math.abs(minutes) * 60) % 60);
		    var returnval = sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
		    s += '<br/>' + primaryY.series.name + ' : ' + returnval
		    if (secondaryY) {
			    s += '<br/>' + secondaryY.series.name + ' : ' + secondaryY.y.toFixed(2);
			}
		    if (tertiaryY) {
			    s += '<br/>' + tertiaryY.series.name + ' : ' + tertiaryY.y.toFixed(2);
			}
		    return s;
		}
            },
            series: [{
			yAxis: 0,
			color: Highcharts.getOptions().colors[0]
		    }, {
			yAxis: 1,
			color: Highcharts.getOptions().colors[1]
		    }, {
			yAxis: 2,
			color: Highcharts.getOptions().colors[2]
            }],

            yAxis: [{ // Primary yAxis
			reversed: true,
			title: {
			    text: 'First axis',
			    style: {
				color: Highcharts.getOptions().colors[0]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[0]
			    },
			    formatter: function (){
					 var minutes = this.value
					 var sign = minutes < 0 ? "-" : "";
					 var min = Math.floor(Math.abs(minutes));
					 var sec = Math.floor((Math.abs(minutes) * 60) % 60);
					 return sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
					}
			}
		    }, { // Secondary yAxis
			title: {
			    text: 'Second axis',
			    style: {
				color: Highcharts.getOptions().colors[1]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[1]
			    }
			},
			opposite: true
		    }, { // Tertiary yAxis
			title: {
			    text: 'Third axis',
			    style: {
				color: Highcharts.getOptions().colors[2]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[2]
			    }
			},
			opposite: true
            }]
        });
	return newChart;
	} //createEmptyChart

    /**
     * Request data from the server, and populate the graph and chart.
     */
    function requestData() {

	var useEnglish = !$("#usemetric").is(':checked')
        $.ajax({
            url: '/getplot',
            data: {toEnglish: useEnglish},
            dataType: "json",
            success: function(data) {

		// save a global copy
                p = data

		// create a new chart
		chart = createEmptyChart();

                // add the points
                chart.series[0].setData(eval(p.Y0coordinates));
                chart.series[1].setData(eval(p.Y1coordinates));
                chart.series[2].setData(eval(p.Y2coordinates));
                chart.setTitle({
                    text: p.Titletext
                });
                chart.xAxis[0].setTitle({
                    text: p.XName
                });
                chart.yAxis[0].setTitle({
                    text: p.Y0Name
                });
                chart.yAxis[1].setTitle({
                    text: p.Y1Name
                });
                chart.yAxis[2].setTitle({
                    text: p.Y2Name
                });
                chart.series[0].name = p.Y0Name
                chart.series[1].name = p.Y1Name
                chart.series[2].name = p.Y2Name
                
                 // create a new map
		map = new google.maps.Map(document.getElementById('map'), {
		  zoom: 15,
		  center: p.Latlongs[0],
		  mapTypeId: google.maps.MapTypeId.TERRAIN
		});               
		
		// https://snazzymaps.com/style/134/light-dream
		var mapstyles = [{
		      "featureType": "landscape",
		      "stylers": [{
			  "hue": "#FFBB00"
		      }, {
			  "saturation": 43.4
		      }, {
			  "lightness": 37.6
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.highway",
		      "stylers": [{
			  "hue": "#FFC200"
		      }, {
			  "saturation": -61.8
		      }, {
			  "lightness": 45.6
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.arterial",
		      "stylers": [{
			  "hue": "#FF0300"
		      }, {
			  "saturation": -100
		      }, {
			  "lightness": 51.2
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.local",
		      "stylers": [{
			  "hue": "#FF0300"
		      }, {
			  "saturation": -100
		      }, {
			  "lightness": 52
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "water",
		      "stylers": [{
			  "hue": "#0078FF"
		      }, {
			  "saturation": -13.2
		      }, {
			  "lightness": 2.4
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "poi",
		      "stylers": [{
			  "hue": "#00FF6A"
		      }, {
			  "saturation": -1.0989010989011
		      }, {
			  "lightness": 11.2
		      }, {
			  "gamma": 1
		      }]
		  }];

		map.setOptions({styles: mapstyles});

		var runPath = new google.maps.Polyline({
		  path: p.Latlongs,
		  geodesic: true,
		  strokeColor: '#ff0000',
		  strokeOpacity: 0.5,
		  strokeWeight: 2
		});

		runPath.setMap(map);

		// Center map based on path
		var bound = new google.maps.LatLngBounds();
		for (i = 0; i < p.Latlongs.length; i++) {
		  bound.extend( new google.maps.LatLng(p.Latlongs[i].lat, p.Latlongs[i].lng) );
		}
		map.setCenter(bound.getCenter());
		map.fitBounds(bound);

		marker = new google.maps.Marker({
		    position: p.Latlongs[0],
		    title:"Here we are!"
		});
		marker.setMap(map);

		// Listen to mouse moves over the chart.
		chartDiv = document.getElementById('container');
		google.maps.event.addDomListener(chartDiv, 'mousemove', function(e){
			 moveMarker(e);
			});
            },
            cache: false
        }); 

    } 

    $(document).ready(function() {

	// Submit the file upload form.
	document.getElementById("myfiles").onchange = function() {
	    document.getElementById("myform").submit();
	}

	//
        //Here's the global options object...
	//

        /**
         * Grid-light theme for Highcharts JS
         * @author Torstein Honsi
         */
        // Load the fonts
        Highcharts.createElement('link', {
            href: 'https://fonts.googleapis.com/css?family=Dosis:400,600',
            rel: 'stylesheet',
            type: 'text/css'
        }, null, document.getElementsByTagName('head')[0]);

        Highcharts.theme = {

            colors: ["#70c6ea", "#6de8c3", "#ce7190", "#b28585","#75bedd", "#aaeeee", "#ff0066", "#eeaaee",
                "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"
            ],
            chart: {
                backgroundColor: null,
                style: {
                    fontFamily: "Dosis, sans-serif"
                }
            },
            title: {
                style: {
                    fontSize: '16px',
//                    fontWeight: 'bold',
                    textTransform: 'uppercase'
                }
            },
            tooltip: {
                borderWidth: 0,
                backgroundColor: 'rgba(219,219,216,0.8)',
                shadow: false
            },
            legend: {
                itemStyle: {
                    fontWeight: 'bold',
                    fontSize: '14px'
                }
            },
            xAxis: {
                gridLineWidth: 2,
                title: {
                    style: {
                        textTransform: 'uppercase',
                        fontSize: '14px'
                    }
                },
                labels: {
                    style: {
                        fontSize: '14px'
                    }
                }
            },
            yAxis: {
                minorTickInterval: 'auto',
                title: {
                    style: {
                        textTransform: 'uppercase',
                        fontSize: '14px'
                    }
                },
                labels: {
                    style: {
                        fontSize: '14px'
                    }
                }
            },
            plotOptions: {
                series: {
                    shadow: false
                },
                candlestick: {
                    lineColor: '#404048'
                }
            },


            // General
            background2: '#F0F0EA'

        };

        // Apply the theme
        Highcharts.setOptions(Highcharts.theme);

    });

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsay4E0YcVz-1-OdkSnAoTBn7Axtqbw7Y">
</script>

<style>
.mytext { font-family: Dosis, serif; font-size: 14px; opacity: 0.8 }
.myborder1{ border: 1px ridge rgba(90, 90, 90, .5); }

</style>



</head>
<body>

<div style="width: 800px; margin: 0 auto">
    <div id="container2" class="myborder1 mytext"  style="float: left; width: 350px; height: 380px; padding-top: 10px;padding-left: 10px;padding-right: 10px;padding-bottom: 10px" >
	    How do I use this?
	    </br></br>Step 1: Load a FIT or TCX file from your computer.
	    <form id="myform" class="mytext" method="post" enctype="multipart/form-data">
		    <input type="file" name="myfiles" id="myfiles" style="color:transparent" multiple="multiple">
	    </form>
	    </br>Step 2: Plot it.
	    </br><input type="checkbox" name="unitsystem" id="usemetric"  value="Metric"> Metric?
	    <input type="button" onclick="requestData()" class="mytext" value="Plot">
	    </br></br>Step 3: Toggle to show/hide trends for:</br>
	    <input type="checkbox" onclick="showHide(0)" class="mytext" value="Pace" checked="checked" >
	    Pace
	    <input type="checkbox" onclick="showHide(1)" class="mytext" value="Elevation" checked="checked" >
	    Elevation
	    <input type="checkbox" onclick="showHide(2)" class="mytext" value="Cadence" checked="checked" >
	    Cadence
	    </br></br>Step 4: Click and drag in the plot area to zoom in.  Shift-drag = pan
    </div>
    <div id="map" class="myborder1" style="float: left;width: 405px;height: 380px;border-left:None;padding-top: 10px;padding-left: 10px;padding-right: 10px;padding-bottom: 10px;"></div>
    <div id="container" class="myborder1" style="float: left; width: 776px; height: 400px; border-top:None; padding-top: 10px;padding-left: 10px;padding-right: 10px;padding-bottom: 10px"></div>
    <br style="clear: left;" />
</div>


  </body>
</html>

