<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.js"></script>
<script type="text/javascript" src="http://cdn.jsdelivr.net/jquery.cookie/1.3/jquery.cookie.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsay4E0YcVz-1-OdkSnAoTBn7Axtqbw7Y"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript"> google.charts.load('current', {'packages':['corechart', 'bar', 'table', 'gauge']}); </script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.2.4/jquery.contextMenu.min.js" type="text/javascript"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.2.4/jquery.contextMenu.min.css" rel="stylesheet" type="text/css" />

<!-- JavaScript/jQuery code starts here. -->   

<script>
    "use strict";

	var serverdata
	var dbfilelist
	
    //
    // This event fires when the document's DOM is loaded (which may be some 
    // time before the images, etc. are loaded).
    //
    $(document).ready(function () {

    	// Set the hook for submitting the file upload form.
    	document.getElementById("runfile").onchange = function () {
			//for every file...
			for (var x = 0; x < this.files.length; x++) {
				var filename = this.files[x].name;
				var fileExt = filename.slice(filename.length - 3, filename.length);
				fileExt = fileExt.toLowerCase();
				sendFile(this.files[x], fileExt);
			}
    	}

    	// Set the hook for submitting the file upload form.
    	document.getElementById("runfilemenu").onchange = function () {
			for (var x = 0; x < this.files.length; x++) {
				var filename = this.files[x].name;
				var fileExt = filename.slice(filename.length - 3, filename.length);
				fileExt = fileExt.toLowerCase();
				sendFile(this.files[x], fileExt);
			}
    	}
    });

	//
	//  Send the file!
	//
	function sendFile (file, fileExt) {
	  		// Check file extension.
    		if (fileExt != "fit" && fileExt != "tcx") {
				var notification = document.querySelector('.mdl-js-snackbar');
				notification.MaterialSnackbar.showSnackbar(
				{
					message: 'Error: filetype is:' + fileExt + '. FitPlot only supports .fit and .tcx files at this time.'
				}
				);
    			return false;
    		} // end if file not the right type

    		var formData = new FormData();
    		formData.append('file', file)
    		$.ajax({
    			url: "/",
    			type: "post",
    			data: formData,
    			processData: false,
    			contentType: false,
    			success: function () {
					var notification = document.querySelector('.mdl-js-snackbar');
					notification.MaterialSnackbar.showSnackbar(
					{
						message: file.name  + ' load completed successfully.'  
					}
					);
    				if ($("#fixed-tab-1").hasClass("is-active")) {
						summarize();
    				} 
    				if ($("#fixed-tab-2").hasClass("is-active")) {
						visualize();
    				} 
    				if ($("#fixed-tab-3").hasClass("is-active")) {
						analyze();
    				} 
    				if ($("#fixed-tab-4").hasClass("is-active")) {
						requestRuns();
    				} 
    			},
    			error: function () {
					var notification = document.querySelector('.mdl-js-snackbar');
					var data = {
					message: file.name + ' load failed.  Error uploading file.',
					actionHandler: function(event) {sendFile(file, fileExt);},
					actionText: 'Retry',
					timeout: 10000
					};
					notification.MaterialSnackbar.showSnackbar(data);
									}
								});
	}

    //
    // This event fires after the window loads.
    //
	$(window).load(function () {
		var nocookies = true
    	// Set the checkboxes based on the cookie when the window loads.
    	$("input.mdl-checkbox__input").each(function () {
    		var mycookie = $.cookie($(this).attr('id'));
    		if (mycookie && mycookie == "true") {
    			$(this).prop('checked', mycookie);
    			nocookies = false;
    		}
    	});

    	// Set the textbox values based on the cookie when the window loads.
    	$("input.mdl-textfield__input").each(function () {
    		var mycookie = $.cookie($(this).attr('id'));
    		if (mycookie != null) {
    			$(this).prop('value', mycookie);
    			nocookies = false;
    		}
    	});

    	// Set the hook for storing/updating the cookie when the checkbox changes.
    	$("input.mdl-checkbox__input").change(function () {
    		$.cookie($(this).attr("id"), $(this).prop('checked'), {
    			path: '/',
    			expires: 365
    		});
    	});

    	// Set the hook for storing/updating the cookie when the textbox value changes.
    	$("input.mdl-textfield__input").change(function () {
    		$.cookie($(this).attr("id"), $(this).prop('value'), {
    			path: '/',
    			expires: 365
    		});
    	});
    	// If no cookies, the program is running for the first time.  We'll set the 
    	// pace trend so the user has something to look at.
    	if (nocookies) {
			$("#pacechk").prop('checked', true);
    	}
    	// Need to initialize the calendar or it doesn't display properly.
		if ($("#fixed-tab-4").hasClass("is-active")) {
			requestRuns();
    	} 
    	
    	
    	$(function() {
        $.contextMenu({
            selector: '.run_base_div', 
            items: {
				"visualize": {name: "Visualize this run",
							  callback: function(key, options)  {
										openTab(2)
									}
							  },
				"summarize": {name: "Summarize this run",
							  callback: function(key, options)  {
										openTab(1)
									}
							  },						  
				"analyze": {name: "Analyze this run",
							  callback: function(key, options)  {
										openTab(3)
									}
							  },
            }
        });
		});
    	
    	
    	
    });

	//
	// Enable/disable UI input fields
	//
//		$('.mdl-radio').click(function () {
//		$('input[type="radio"]').click(function() {
	function disableInputs () {
		//document.getElementById("splitdist").disabled = true;
		document.getElementById("splitdisttf").MaterialTextfield.disable(); 
		document.getElementById("splithourstf").MaterialTextfield.disable(); 
		document.getElementById("splitminstf").MaterialTextfield.disable(); 
		document.getElementById("splitsecstf").MaterialTextfield.disable(); 
		};
	function enableInputs () {
		//document.getElementById("splitdist").disabled = false;
		document.getElementById("splitdisttf").MaterialTextfield.enable();
		document.getElementById("splithourstf").MaterialTextfield.enable();
		document.getElementById("splitminstf").MaterialTextfield.enable();
		document.getElementById("splitsecstf").MaterialTextfield.enable();
		};

    //
    // Request data from the server.
    //
    function requestData() {
		var data = {
		"UseEnglish" : !$("#usemetric").is(':checked'),
		"Racedist" : parseFloat($("#racedist")[0].value),
		"Racehours" : parseInt($("#racehours")[0].value),
		"Racemins" : parseInt($("#racemins")[0].value),
		"Racesecs" : parseInt($("#racesecs")[0].value),
		"UseSegment" : $("#calc-2").is(':checked'),
		"Splitdist" : parseFloat($("#splitdist")[0].value),
		"Splithours" : parseInt($("#splithours")[0].value),
		"Splitmins" : parseInt($("#splitmins")[0].value),
		"Splitsecs" : parseInt($("#splitsecs")[0].value),
		}
    	$.ajax({
    		url: '/getplot',
    		type: 'POST',
    		data: JSON.stringify(data),
    		error: function(XMLHttpRequest, textStatus, errorThrown) {
				var e = XMLHttpRequest.error()
				if (e.status == 409) {
					var notification = document.querySelector('.mdl-js-snackbar');
					notification.MaterialSnackbar.showSnackbar( {
					message: e["responseText"]
					} );				
				}
    		},
    		success: function (returneddata) {
    			// Save a global copy.
				serverdata = returneddata;
    		},
    		cache: false
    	});
    };
    
    //
    // Request a list of runs from the server.
    //
    function requestRuns() {
		// Do a little fancy footwork to format the calendar dates into
		// database compatible timestamps.
		var dbStartDate = $.datepicker.parseDate( "mm/dd/yy", $("#calStart").val() )
		var dbStart = $.datepicker.formatDate("yy-mm-dd", dbStartDate)
		var dbEndDate = $.datepicker.parseDate( "mm/dd/yy", $("#calEnd").val() )
		var dbEnd = $.datepicker.formatDate("yy-mm-dd", dbEndDate)
		var data = {"dbStart": dbStart, "dbEnd": dbEnd}
    	$.ajax({
    		url: '/getruns',
    		data: JSON.stringify(data),
    		type: 'POST',
    		error: function(XMLHttpRequest, textStatus, errorThrown) {
				var e = XMLHttpRequest.error()
				if (e.status != 200) {
					var notification = document.querySelector('.mdl-js-snackbar');
					notification.MaterialSnackbar.showSnackbar( {
					message: e["responseText"]
					} );				
				}
    		},
    		cache: false
    	}).done(function(returneddata){
				dbfilelist = returneddata;
				createCalendar()
				createFileTable(dbfilelist)

			});
    };
    
    //
    // Display the environment the program is executing in.
    //
    function showEnvironment() {
    	$.ajax({
    		url: '/env',
    		data: {},
    		dataType: "json",
    		success: function (returneddata) {
				var notification = document.querySelector('.mdl-js-snackbar');
				notification.MaterialSnackbar.showSnackbar( {
				message: 'Browser: ' + navigator.userAgent
				} );
				notification.MaterialSnackbar.showSnackbar( {
				message: 'Operating system: ' + returneddata.OperatingSystem 
				} );
				notification.MaterialSnackbar.showSnackbar( {
				message: 'CPU architecture: ' + returneddata.CPUArchitecture
				} );
				notification.MaterialSnackbar.showSnackbar( {
				message: 'Build time stamp: ' + returneddata.Buildstamp
				} );			
				notification.MaterialSnackbar.showSnackbar( {
				message: 'Git hash: ' + returneddata.Githash
				} );

    		},
    		cache: false
    	});
    };

	//
	// Programatically open and display a tab's content.
	//
    function openTab(tabnum) {
		var tabname = "#fixed-tab-"
		tabname = tabname + tabnum
    	// remove all is-active classes from tabs
		$('a.mdl-layout__tab').removeClass('is-active');
		// activate desired tab
		$('a[href=' + tabname + ']').addClass('is-active');
		//$('a[href="#fixed-tab-2"]').addClass('is-active');
		// remove all is-active classes from panels
		$('.mdl-layout__tab-panel').removeClass('is-active');
		// activate desired tab panel
		$(tabname).addClass('is-active');
		if (tabnum == 2) { visualize() }
		if (tabnum == 1) { summarize() }
		if (tabnum == 3) { analyze() }
		if (tabnum == 4) { requestRuns() }
    }
    
    //
    // Display the stored runs tab.
    //
	$(function () {
		$('.str-tab').click(function () {
			requestRuns()
		})
	});
	
	
	//
    // Show the datepicker information.
	//
	function createCalendar(serverdata) {
		$("#datepicker").datepicker({
			beforeShowDay: function(date) {
				var date1 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#calStart").val());
				var date2 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#calEnd").val());
				return [true, date1 && ((date.getTime() == date1.getTime()) || (date2 && date >= date1 && date <= date2)) ? "dp-highlight" : ""];
			},
			onSelect: function(dateText, inst) {
				var date1 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#calStart").val());
				var date2 = $.datepicker.parseDate($.datepicker._defaults.dateFormat, $("#calEnd").val());
				if (!date1 || date2) {
					$("#calStart").val(dateText);
					$("#calEnd").val("");
					$(this).datepicker("option", "minDate", dateText);
				} else {
					$("#calEnd").val(dateText);
					$(this).datepicker("option", "minDate", null);
					requestRuns();
				}
			}
		});
		$("#datepicker").datepicker( "refresh" )
	}
    //
    // Create the database file table using the Google Charts API.
    //
    function createFileTable(dbfilelist) {
    
    	// Add file values to the database file table.
    	
    	var filedata = new google.visualization.DataTable();
//    	filedata.addColumn('string', 'Time stamp');
    	filedata.addColumn('number', 'Distance');
    	filedata.addColumn('string', 'Moving Time');
    	filedata.addColumn('string', 'Date');
    	filedata.addColumn('string', 'Time of Day');
    	filedata.addColumn('string', 'Time zone');
    	filedata.addColumn('string', 'Weekday');
    	filedata.addColumn('string', 'File name');
    	filedata.addColumn('string', 'File format');
    	var cellStyle = {
    		style: 'font-family: Roboto, sans-serif; font-size: 12px; opacity: 0.; text-align:center; vertical-align:middle'
    	}
    	if (dbfilelist == null) {
    		filedata.addRows([
    			[ 0.0, '', '', '', '', '', '', ''],
    		]);
    	} else {
    	   	var row = 0;
			for (var i = 0; i < dbfilelist.length; i++) {
				filedata.addRows([
					[ parseFloat(dbfilelist[i]['Distance']), dbfilelist[i]['Moving time'], dbfilelist[i]['Date'], dbfilelist[i]['Time'], dbfilelist[i]['Time zone'], dbfilelist[i]['Weekday'], dbfilelist[i]['File name'], dbfilelist[i]['File type'] ],
				]);
				filedata.setProperties(row, 0, cellStyle);
				filedata.setProperties(row, 1, cellStyle);
				filedata.setProperties(row, 2, cellStyle);
				filedata.setProperties(row, 3, cellStyle);
				filedata.setProperties(row, 4, cellStyle);
				filedata.setProperties(row, 5, cellStyle);
				filedata.setProperties(row, 6, cellStyle);
				filedata.setProperties(row, 7, cellStyle);
				row = row + 1
			}
    	}
    	filedata.sort({column: 2, desc: false});
    	var filetable = new google.visualization.Table(document.getElementById('run_dbase_div'));
    	var fileoptions =  {
    		showRowNumber: false,
    		width: '100%',
    		height: '40vh',
    		allowHtml: true
    	} 
    	filetable.draw(filedata, fileoptions);
    	
    	// Create a column chart
    	
    	var view = new google.visualization.DataView(filedata);
		view.setColumns([2, 0]);
		var baroptions = {
		// This would be nice but there's a bug in the API when using a view. :(
		//        animation: {
		//          duration: 1000,
		//          easing: 'out',
		//          startup: true
		//		},
			bar: {groupWidth: '95%'},
			legend: { position: 'none'},
			height: '40vh',
			colors: ['#2196f3']
		};
		var colchart = new google.visualization.ColumnChart(document.getElementById('run_bar_div'));
		colchart.draw(view, baroptions);  
		
    	// Add our selection file handler.
    	
		google.visualization.events.addListener(filetable, 'select', selectHandler);
		function selectHandler() {
			var selection = filetable.getSelection();
			var message = '';
			for (var i = 0; i < selection.length; i++) {
				var item = selection[i];
				if (item.row != null && item.column != null) {
				var str = filedata.getFormattedValue(item.row, item.column);
				message += '{row:' + item.row + ',column:' + item.column + '} = ' + str + '\n';
				} else if (item.row != null) {
				var dateStr = filedata.getFormattedValue(item.row, 2)
				var timeStr = filedata.getFormattedValue(item.row, 3)
				var timeZone = filedata.getFormattedValue(item.row, 4)
				var data = {"DateStr": dateStr, "TimeStr": timeStr, "TimeZoneStr": timeZone}
				$.ajax({
					url: '/selectrun',
					data: JSON.stringify(data),
					type: 'POST',
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						var e = XMLHttpRequest.error()
						if (e.status != 200) {
							var notification = document.querySelector('.mdl-js-snackbar');
							notification.MaterialSnackbar.showSnackbar( {
							message: e["responseText"]
							} );				
						}
					},
					cache: false
				});
				message += '{row:' + item.row + ', column:none}; value (col 0) = ' + str + '\n';
				} else if (item.column != null) {
				var str = filedata.getFormattedValue(0, item.column);
				message += '{row:none, column:' + item.column + '}; value (row 0) = ' + str + '\n';
				}
			}
		}
		
		// Sort the column chart when the table sorts.
		
		google.visualization.events.addListener(filetable, 'sort', sortHandler);
		function sortHandler() {
			var rslt = filetable.getSortInfo()
			filedata.sort({column: rslt["column"], desc: !rslt["ascending"]});
			filetable.draw(filedata, fileoptions);
			colchart.draw(view, baroptions);   
		}
    }
	

	//
	// Summarize tab has been selected.
	//
	$(function () {
		$('.sum-tab').click(function () {
			summarize()
		})
	});
	
	//
	// Show the summary information.
	//
	function summarize() {
		requestData();
		setTimeout(function(){ 
			createSummary(serverdata);
			createLaps(serverdata);
		}, 1000);
	}

	//
	// Visualize tab has been selected.
	//
	$(function () {
		$('.vis-tab').click(function () {
			visualize();
		})
	});

	//
	// Plot the graph and map using the current data.
	//
	function visualize() {
		var showPace = $("#pacechk").is(':checked')
		var showElev = $("#elevchk").is(':checked')
		var showCad = $("#cadchk").is(':checked')
		requestData();
		setTimeout(function(){ 
			var marker = createMap(serverdata);
			createGraph(serverdata, showPace, showElev, showCad, marker);
		}, 1000);
	}

	//
	// Analyze tab has been selected.
	//
	$(function () {
		$('.ana-tab').click(function () {
			analyze();
		})
	});

	//
	// Rerun the analysis and display.
	//
	function analyze() {
		requestData();
		// Since asynchronous must give the server time to recalculate before
		// plotting.
		setTimeout(function(){ 
			createRace(serverdata);
			createScore(serverdata);
			createTraining(serverdata);
		}, 1000);
	}

    //
    // Create the summary using the DOM.
    //
    function createSummary(p) {
    	// Write summary information.
    	$("#over_div").empty();
    	var summary = document.getElementById('over_div')
    	summary.innerHTML += '</br>Congrats on your run!</br>';
    	summary.innerHTML += '</br><b>Distance: </b> ' + p.DispTotalDistance;
    	summary.innerHTML += '</br><b>Moving Time: </b> ' + p.DispMovingTime;
    	summary.innerHTML += '</br><b>Pace: </b> ' + p.TotalPace;
    	summary.innerHTML += '</br><b>Start:</b> ' + p.StartDateStamp;
    	summary.innerHTML += '</br><b>End: </b> ' + p.EndDateStamp;
    	summary.innerHTML += '</br><b>Total Energy: </b>' + p.TotalCal;
    	summary.innerHTML += '</br><b>Average Power: </b>' + p.AvgPower;
    	summary.innerHTML += '</br><b>Device Name: </b>' + p.DeviceName;
    	summary.innerHTML += '</br><b>Device Product ID: </b>' + p.DeviceProdID;
    	summary.innerHTML += '</br><b>Device Serial Number: </b>' + p.DeviceUnitID;
    }

    //
    // Create the map using the Google map API.
    //
    function createMap(p) {
    	// Create a new map.
    	var map = new google.maps.Map(document.getElementById('mapDiv'), {
    		zoom: 15,
    		center: p.Latlongs[0],
    		mapTypeId: google.maps.MapTypeId.TERRAIN
    	});
    	// Create a path line.  
    	var runPath = new google.maps.Polyline({
    		path: p.Latlongs,
    		geodesic: true,
    		strokeColor: '#ff0000',
    	});
    	runPath.setMap(map);
    	// Center map based on path.
    	var bound = new google.maps.LatLngBounds();
    	for (var i = 0; i < p.Latlongs.length; i++) {
    		bound.extend(new google.maps.LatLng(p.Latlongs[i].lat, p.Latlongs[i].lng));
    	}
		map.setCenter(bound.getCenter());
		map.fitBounds(bound);

    	// Add a marker.
    	var marker = new google.maps.Marker({
    		position: p.Latlongs[0],
    		title: "Here we are!"
    	});
    	marker.setMap(map);

		// Force a refresh!
		setTimeout(function () {
			google.maps.event.trigger(map, 'resize');
			//map.setCenter(mapOptions.center);
		}, 500);

    	// Return the marker object for use with graph.
    	return marker;
    }

	// Utility function to convert time in decimal minutes to mm:ss.
	// Does not handle input values > one hour.
	function decimalTimetoMinSec(dectime) {
		var in_min = Math.floor(dectime);
		var in_min_str = in_min.toString();
		if (in_min < 10) {
			var in_min_str = "0" + in_min_str;
		}
		var in_sec = Math.round((dectime - in_min) * 60);
		var in_sec_str = in_sec.toFixed(0).toString();
		if (in_sec < 10) {
			in_sec_str = "0" + in_sec_str;
		}
		var out = in_min_str + ":" + in_sec_str;
		return out
	}

	//
	//	Create an array of tick values and associated text to display in mins/unit.
	//
	function paceTicks(pace_array) {
			var tickvals = [];
			var ticktext = [];
			var max_of_array = Math.max.apply(Math, pace_array);
			var min_of_array = Math.min.apply(Math, pace_array);
			var range = max_of_array - min_of_array; //minutes
			// We want 5 - 10 ticks on display.
			var step_interval;
			if (10.0 < range) { step_interval = 120.0 } //seconds
			if ((5.0 < range) && (range <= 10.0)) { step_interval = 60.0 } //seconds
			if ((2.5 < range) && (range <= 5.0)) { step_interval = 30.0 } //seconds
			if ((1.25 < range) && (range <= 2.5)) { step_interval = 15.0 } //seconds
			if ((50.0/60.0 < range) && (range <= 1.25)) { step_interval = 10.0 } //seconds
			if (range <= 50/60.0) { step_interval = 5.0 } //seconds
			for (var i = 0.0; i < 1800.0; i = i + step_interval ) {
				tickvals.push(i/60.0)
				ticktext.push(decimalTimetoMinSec(i/60.0))
			}
			return {tickvals : tickvals, ticktext : ticktext};
		}
	
    //
    // Create the run graph using the Plotly API.
    //
    function createGraph(p, showPace, showElev, showCad, marker) {
    	// Boilerplate for fluid layout.
    	var d3 = Plotly.d3;
		var WIDTH_IN_PERCENT_OF_PARENT = 99; 
		// window.innerHeight should be set based on style settings for the "card".
    	var HEIGHT_IN_PERCENT_OF_PARENT = Math.floor(window.innerHeight/screen.height * 100);
    	var gd3 = d3.select("#plotlyDiv")
    		.style({
    			width: WIDTH_IN_PERCENT_OF_PARENT + '%',
    			'margin-left': (100 - WIDTH_IN_PERCENT_OF_PARENT) / 2 + '%',
    			height: HEIGHT_IN_PERCENT_OF_PARENT + 'vh',
    		});
    	var gd = gd3.node();

    	// Clean out the drawing surface.
    	Plotly.purge(plotlyDiv);

		// Custom hover text strings (e.g. convert decimal times to mm:ss for plotting).
		var x = [];
		var y = [];
		var y1 = [];
		var y2 = [];
		var paceForHumans = [];
		var altitudeForHumans = [];
		var cadenceForHumans = [];
		p.DispDistance.forEach(function(item, index)
		{
			x.push(item);
			y.push(p.DispPace[index]);
			y1.push(p.DispAltitude[index]);
			y2.push(p.DispCadence[index]);
			paceForHumans.push(p.Y0Name + ' = ' + decimalTimetoMinSec(p.DispPace[index]));
			altitudeForHumans.push(p.Y1Name +  ' = ' + p.DispAltitude[index].toFixed(0) );
			cadenceForHumans.push(p.Y2Name + ' = ' + p.DispCadence[index].toFixed(0) );
		});

    	//Create a Plotly chart.
    	var trace1 = {
    		x: x,
    		y: y,
    		name: p.Y0Name,
    		type: 'scatter',
    		yaxis: 'y',
    		line: {
    			color: "#1f77b4"
    		},
    		visible: showPace,
			text: paceForHumans,
			hoverinfo: "text",
    	};

    	var trace2 = {
    		x: x,
    		y: y1,
    		name: p.Y1Name,
    		yaxis: 'y2',
    		type: 'scatter',
    		line: {
    			color: "#ff7f0e"
    		},
    		visible: showElev,
			text: altitudeForHumans,
			hoverinfo: "text",
    	};

    	var trace3 = {
    		x: x,
    		y: y2,
    		name: p.Y2Name,
    		yaxis: 'y3',
    		type: 'scatter',
    		line: {
    			color: "#4DAF4A"
    		},
    		visible: showCad,
			text: cadenceForHumans,
			hoverinfo: "text",
    	};


    	var data = [trace1, trace2, trace3];

    	var yaxisTitle = showPace ? p.Y0Name : '';
    	var yaxis2Title = showElev ? p.Y1Name : '';
    	var yaxis3Title = showCad ? p.Y2Name : '';

		var pTicks = paceTicks(p.DispPace);

    	var layout = {
    		showlegend: false,
    		//	  hovermode: 'closest',
    		title: p.Titletext,
    		xaxis: {
    			title: p.XName,
    			domain: [0.0, 0.90],
    			titlefont: {
    				size: 14
    			},
    			tickfont: {
    				size: 14
    			},
    			gridcolor: '#bdbdbd',
    			gridwidth: 1,
				hoverformat: '.2f',
    		},
    		//	  legend: {
    		//	    orientation: "h",
    		//	  },


    		yaxis: {
    			title: yaxisTitle,
    			titlefont: {
    				color: '#1f77b4',
    				size: 14
    			},
    			tickfont: {
    				color: '#1f77b4',
    				size: 14
    			},
				tickvals: pTicks.tickvals,
                ticktext : pTicks.ticktext,
    			autorange: 'reversed',
    			anchor: 'x',
    			side: 'left',
    			position: 0,
    			showgrid: showPace,
    			showticklabels: showPace,
    			zeroline: false,
    		},

    		yaxis2: {
    			title: yaxis2Title,
    			titlefont: {
    				color: '#ff7f0e',
    				size: 14
    			},
    			tickfont: {
    				color: '#ff7f0e',
    				size: 14
    			},
    			overlaying: 'y',
    			anchor: 'x',
    			side: 'right',
    			showgrid: showElev,
    			showticklabels: showElev,
    			zeroline: false,
				hoverformat: '.0f',

    		},
    		yaxis3: {
    			title: yaxis3Title,
    			titlefont: {
    				color: '#4DAF4A',
    				size: 14
    			},
    			tickfont: {
    				color: '#4DAF4A',
    				size: 14
    			},
    			anchor: 'free',
    			overlaying: 'y',
    			side: 'right',
    			position: 1,
    			showgrid: showCad,
    			showticklabels: showCad,
    			zeroline: false,
				hoverformat: '.0f',
    		},
    		font: {
    			family: "Roboto, sans-serif",
    			size: 0,
    		},
			annotations: [{
				xref: 'paper',
				yref: 'paper',
				x: 0.5,
				xanchor: 'center',
				y: 1.0,
				yanchor: 'bottom',
				text: '',
				showarrow: false,
				font: {
				family: 'Roboto, sans-serif',
				size: 14,
				color: '#1f77b4'
				},
//				bgcolor: '#1f77b4',
				opacity: 0.8
				}]
    	};
    	Plotly.plot(gd, data, layout);
		Plotly.Plots.resize(gd);

    	// Handle resizing.
    	window.onresize = function () {
    		Plotly.Plots.resize(gd);
    	};

    	// Move the map marker when over a point in the graph.
    	var myPlot = document.getElementById('plotlyDiv');
    	myPlot.on('plotly_hover', function (data) {
    		var pts = '';
    		for (var i = 0; i < data.points.length; i++) {
    			pts = 'x = ' + data.points[i].x + '\ny = ' +
    				data.points[i].y.toPrecision(4) + '\n\n';

    			var distances = document.getElementById('plotlyDiv').data[0].x
    			for (var j = 0; j < distances.length; j++) {
    				if (distances[j] > data.points[i].x) {
    					break;
    				}
    			}
    			var moveLatlong = p.Latlongs[j - 1];
    			marker.setPosition(moveLatlong);
    		}
    	});
		// Calculate 'local' averages on zoom.
		myPlot.on('plotly_relayout', function(eventdata){
				if ((eventdata.hasOwnProperty('xaxis.range[0]')) && (eventdata.hasOwnProperty('xaxis.range[1]'))) {
					var xmin = eventdata['xaxis.range[0]'];
					var xmax = eventdata['xaxis.range[1]'];
					var plot = document.getElementById('plotlyDiv')
					var pace = plot.data[0];
					var elevation = plot.data[1];
					var cadence = plot.data[2];
					var sum = 0.0;
					var count = 0;
					for (var i = 0; i < pace.x.length; i++) {
						if (pace.x[i] >= xmin && pace.x[i] <= xmax) {
							sum += pace.y[i]
							count += 1
						}
					}
					var avgPace = sum/count;
					sum = 0.0;
					count = 0;
					for (var i = 0; i < elevation.x.length; i++) {
						if (elevation.x[i] >= xmin && elevation.x[i] <= xmax) {
							sum += elevation.y[i]
							count += 1
						}
					}
					var avgElevation = sum/count;
					sum = 0.0;
					count = 0;
					for (var i = 0; i < cadence.x.length; i++) {
						if (cadence.x[i] >= xmin && cadence.x[i] <= xmax) {
							sum += cadence.y[i]
							count += 1
						}
					}
					var avgCadence = sum/count;
					var myAnnotation = 'Segment average: ' +  ' ';
					if (showPace) { myAnnotation += p.Y0Name + '=' + decimalTimetoMinSec(avgPace) + ' ' }
					if (showElev) { myAnnotation += p.Y1Name + '=' + avgElevation.toFixed(0) + ' ' }
					if (showCad) { myAnnotation += p.Y2Name + '=' + avgCadence.toFixed(0) + ' ' }
					// Is this the best way to get the annotation???
					var annotation = plot.attributes[1].ownerElement.layout.annotations[0]
					annotation.text = myAnnotation
					// Get slice of p.DispPace on zoomed in data and recalculate the 
					//axis tick values and text.
					var startidx, endidx = 0;
					for (var i = 0; i < pace.x.length; i++) {
						if (pace.x[i] < xmin) { startidx = i; }
						if (pace.x[i] < xmax) { endidx = i; }
					}
					var paceSlice = p.DispPace.slice(startidx, endidx);
					// calculate paceTicks for this slice
					var pTicks = paceTicks(p.DispPace.slice(startidx, endidx));
					// assign paceTicks to yaxis.tickvals, yaxis.ticktext
					var plot = document.getElementById('plotlyDiv');
					var yaxis = plot.attributes[1].ownerElement.layout.yaxis;
					yaxis.tickvals = pTicks.tickvals;
					yaxis.ticktext = pTicks.ticktext;
					Plotly.redraw(plot)
				}
				// Clear it out if unzooming
				if (eventdata.hasOwnProperty('xaxis.autorange')) {
					var plot = document.getElementById('plotlyDiv')
					var annotation = plot.attributes[1].ownerElement.layout.annotations[0]
					var pTicks = paceTicks(p.DispPace);
					var yaxis = plot.attributes[1].ownerElement.layout.yaxis;
					yaxis.tickvals = pTicks.tickvals;
					yaxis.ticktext = pTicks.ticktext;
					annotation.text = ''
					Plotly.redraw(plot)
				}
			});

    }

    //
    // Create the lap table using the Google Charts API.
    //
    function createLaps(p) {
    	// Add lap values to the data table.	
    	var data = new google.visualization.DataTable();
    	data.addColumn('number', p.C0Str);
    	data.addColumn('number', p.C1Str);
    	data.addColumn('string', p.C2Str);
    	data.addColumn('string', p.C3Str);
    	data.addColumn('number', p.C4Str);
    	var cellStyle = {
    		style: 'font-family: Roboto, sans-serif; font-size: 12px; opacity: 0.; text-align:center; vertical-align:middle'
    	}
    	for (var i = 0; i < p.LapDist.length; i++) {
    		data.addRows([
    			[i + 1, p.LapDist[i], p.LapPace[i], p.LapTime[i], p.LapCal[i]],
    		]);
    		data.setProperties(i, 0, cellStyle);
    		data.setProperties(i, 1, cellStyle);
    		data.setProperties(i, 2, cellStyle);
    		data.setProperties(i, 3, cellStyle);
    		data.setProperties(i, 4, cellStyle);
    	}
    	var table = new google.visualization.Table(document.getElementById('table_div'));
    	table.draw(data, {
    		showRowNumber: false,
    		width: '100%',
    		height: '100%',
    		allowHtml: true
    	});
    }

    //
    // Create the race prediction table using the Google Charts API.
    //
    function createRace(p) {
    	// Add predicted race values to the prediction table.
    	var preddata = new google.visualization.DataTable();
    	preddata.addColumn('string', 'Race');
    	preddata.addColumn('string', 'Time (hh:mm:ss)');
    	var cellStyle = {
    		style: 'font-family: Roboto, sans-serif; font-size: 12px; opacity: 0.; text-align:center; vertical-align:middle'
    	}
    	var row = 0;
    	for (var k in p.PredictedTimes) {
    		if (p.PredictedTimes.hasOwnProperty(k)) {
    			preddata.addRows([
    				[k, p.PredictedTimes[k], ]
    			]);
    		}
    		preddata.setProperties(row, 0, cellStyle);
    		preddata.setProperties(row, 1, cellStyle);
    		row = row + 1
    	}
    	preddata.sort({column: 1, desc: false});

    	var predtable = new google.visualization.Table(document.getElementById('prediction_div'));
    	predtable.draw(preddata, {
    		showRowNumber: false,
    		width: '100%',
    		height: '100%',
    		allowHtml: true
    	});

    }

    //
    // Create the race prediction table using the Google Charts API.
    //
    function createTraining(p) {
    	// Add training pace values to the training pace table.
    	var traindata = new google.visualization.DataTable();
    	traindata.addColumn('string', 'Workout');
    	traindata.addColumn('string', 'Pace (mm:ss)');
    	var cellStyle = {
    		style: 'font-family: Roboto, sans-serif; font-size: 12px; opacity: 0.; text-align:center; vertical-align:middle'
    	}
    	var row = 0;
    	for (var k in p.TrainingPaces) {
    		if (p.TrainingPaces.hasOwnProperty(k)) {
    			traindata.addRows([
    				[k, p.TrainingPaces[k], ]
    			]);
    		}
    		traindata.setProperties(row, 0, cellStyle);
    		traindata.setProperties(row, 1, cellStyle);
    		row = row + 1
    	}
    	traindata.sort({column: 1, desc: false});
    	var traintable = new google.visualization.Table(document.getElementById('training_div'));
    	traintable.draw(traindata, {
    		showRowNumber: false,
    		width: '100%',
    		height: '100%',
    		allowHtml: true
    	});

    }

	function createScore(p) {

    	$("#run_support").empty();
    	var rs = document.getElementById('run_support')
    	rs.innerHTML += '</br><b>VO<sub>2</sub>run: </b> ' + p.VDOT.toFixed(1) + ' ml/kg/min';
    	rs.innerHTML += '</br><b>VO<sub>2</sub>race/max: </b> ' + p.VO2max.toFixed(1) + ' ml/kg/min';

        var data = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['%VO2max', p.RunScore],
        ]);

        var options = {
          width: 200, height: 200,
          redFrom: 88, redTo: 100,
          yellowFrom:70, yellowTo: 88,
          greenFrom: 0, greenTo: 70,
          minorTicks: 5
        };

        var chart = new google.visualization.Gauge(document.getElementById('run_score_div'));

        chart.draw(data, options);
	}

    //
    // Request data from the server.
    //
    function requestExit() {
		if (confirm("Close Window?")) {
			$.ajax({
				url: '/stop',
				cache: false
			});
			// Give the server 3 seconds - a reasonable amount of time to see the message before leaving.
			setTimeout( function() {window.close(); }, 3000)
		}
    };


</script>

<!-- Styling -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.2.0/material.blue-green.min.css" />
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/redmond/jquery-ui.min.css" >
<script defer src="https://code.getmdl.io/1.2.0/material.min.js"></script>
<style>

#runfile { display: none }
#runfilemenu { display: none }

.mdl-layout__tab-bar {
  height: 5vh;
  width: 100vw;
}

.mdl-mini-footer {
  height: 5vh;
  width: 100vw;
  overflow: hidden;
}

.mdl-card {
  height: 75vh;
  width: 100vw;
}

.google-table {
  height: 65vh;
}

.google-map {
  height: 65vh;
}

.plotlyDiv {
  height: 65vh;
  width: 99%;
  margin-left: 0.5%
}
.mdl-card__subtitle-text {
  padding: 5px;
}

.float-run-button {
   position: absolute;
   top: 0px;
   right: 28px;
   transform: translate(0px, 28px);
   z-index: 4;
}

.mdl-textfield__input {
   width: 75px;
}

.dp-highlight .ui-state-default {
	background: #69f0ae;
	color: #FFF;
}

.ui-widget-header {
	border: 1px solid #4297d7;
	background: #2196f3;
	color: #b3dafa;
	font-weight: bold;
}

</style>

</head>
  <body>

<!-- Simple header with fixed tabs. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header
            mdl-layout--fixed-tabs">
	<header class="mdl-layout__header">
    <!-- Tabs -->
		<div class="mdl-layout__tab-bar mdl-js-ripple-effect">
			<a href="#fixed-tab-4" class="mdl-layout__tab str-tab">Stored Runs</a>
			<a href="#fixed-tab-2" class="mdl-layout__tab vis-tab">Visualize</a>
			<a href="#fixed-tab-1" class="mdl-layout__tab sum-tab">Summarize</a>
			<a href="#fixed-tab-3" class="mdl-layout__tab ana-tab">Analyze</a>
		</div>
	</header>

	<label id="runbtn" for="runfile" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--accent float-run-button ">
		<i class="material-icons">add</i>
		<input type="file" name="runfile" id="runfile" multiple> 
	</label>
	<span for="runbtn" class="mdl-tooltip">Load a Garmin .fit or .tcx file</span>

	<div class="mdl-layout__drawer">
	<span class="mdl-layout-title">FITPLOT</span>
	<nav class="mdl-navigation">
		<label id="runbtnmenu" for="runfilemenu" class="mdl-button mdl-js-button mdl-button--colored">
		<input type="file" name="runfilemenu" id="runfilemenu" multiple> 
		<span>Load file</span>
		</label>
		<button type="button" id="drawer-env" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" onclick="showEnvironment()">Environment</button>
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" target="_blank" href="/static/help.html" >Help</a>
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" target="_blank" href="/static/help.html#license">License</a>
		<button type="button" id="drawer-exit" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" onclick="requestExit()">Exit</button>
	</nav>
	</div>

	<div aria-live="assertive" aria-atomic="true" aria-relevant="text" class="mdl-snackbar mdl-js-snackbar">
		<div class="mdl-snackbar__text"></div>
		<button type="button" class="mdl-snackbar__action"></button>
	</div>

  <main class="mdl-layout__content">
	<section class="mdl-layout__tab-panel is-active" id="fixed-tab-4">
		<div class="page-content"><!-- Your content goes here -->

		<div class="mdl-grid">
			<!-- Calendar -->
			<div class="mdl-card mdl-cell--3-col-desktop mdl-cell--2-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Search</h2>
				</div>
				<div id="datepicker" class="mdl-card__supporting-text">
				</div>      
				<span for="datepicker" class="mdl-tooltip">Select two days on the calendar to bracket the search for runs in the database.</span>
				Start:<input type="text" id="calStart" readonly>
				End:<input type="text" id="calEnd" readonly>
			</div>
			<!-- Run table -->
			<div class="mdl-card mdl-cell--9-col-desktop mdl-cell--6-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Results</h2>
				</div>
				<!--
				<span for="run_bar_div" class="mdl-tooltip">Drag to zoom. Right click to reset.</span>
				-->
				<div class="run_bar_div" id="run_bar_div">
				</div>
				<span for="run_dbase_div" class="mdl-tooltip">Right click on a row to select a run to view.</span>
				<div class="run_base_div" id="run_dbase_div">
				</div>
			</div>
		</div>
		</div>
		<footer class="mdl-mini-footer">
		<div class="mdl-mini-footer__left-section">
			<div class="mdl-logo">
			More Information
			</div>
			<ul class="mdl-mini-footer__link-list">
			<li><a target="_blank" href="/static/help.html">Help</a></li>
			<li><a target="_blank" href="/static/help.html#license">License</a></li>
			</ul>
		</div>
		<div class="mdl-mini-footer__right-section">
		<!--
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
		-->
		</div>
		</footer>
	</section>
  
	<section class="mdl-layout__tab-panel" id="fixed-tab-1">
		<div class="page-content"><!-- Your content goes here -->

		<div class="mdl-grid">
			<!-- Summary -->
			<div class="mdl-card mdl-cell--6-col-desktop mdl-cell--8-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Summary</h2>
				</div>
				<div id="over_div" class="mdl-card__supporting-text">
				</div>      
			</div>
			<!-- Laps/splits -->
			<div class="mdl-card mdl-cell--6-col-desktop mdl-cell--8-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Laps/Splits</h2>
				</div>
				<div class="google-table" id="table_div">
				</div>
			</div>
		</div>

		</div>

		<footer class="mdl-mini-footer">
		<div class="mdl-mini-footer__left-section">
			<div class="mdl-logo">
			More Information
			</div>
			<ul class="mdl-mini-footer__link-list">
			<li><a target="_blank" href="/static/help.html">Help</a></li>
			<li><a target="_blank" href="/static/help.html#license">License</a></li>
			</ul>
		</div>
		<div class="mdl-mini-footer__right-section">
		<!--
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
		-->
		</div>
		</footer>

	</section>
	<section class="mdl-layout__tab-panel" id="fixed-tab-2">
		<div class="page-content"><!-- Your content goes here -->

			<div class="mdl-grid">
			<!-- Graph -->
			<div class="mdl-card mdl-cell--8-col-desktop mdl-cell--8-col-tablet mdl-shadow--3dp"  >
			<div class="mdl-card__title">
				<h2 class="mdl-card__title-text">Graph</h2>
			</div>
			<div class="plotlyGraph" id="plotlyDiv">
			</div>
			<div class="mdl-grid">
				<div class="mdl-cell mdl-cell--3-col-desktop mdl-cell--2-col-tablet">    
					<label id="pacesw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="pacechk">
					<input type="checkbox" id="pacechk" onclick="visualize()" class="mdl-checkbox__input">
					<span class="mdl-checkbox__label"></span>
					</label> Pace
					<span for="pacesw" class="mdl-tooltip">Display/hide pace trend.</span>
				</div>
				<div class="mdl-cell mdl-cell--3-col-desktop mdl-cell--2-col-tablet">    
					<label id="elevsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="elevchk">
					<input type="checkbox" id="elevchk" onclick="visualize()" class="mdl-checkbox__input">
					<span class="mdl-checkbox__label"></span>
					</label> Elevation
					<span for="elevsw" class="mdl-tooltip">Display/hide elevation trend.</span>
				</div>
				<div class="mdl-cell mdl-cell--3-col-desktop mdl-cell--2-col-tablet">    
					<label id="cadsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="cadchk">
					<input type="checkbox" id="cadchk" onclick="visualize()" class="mdl-checkbox__input">
					<span class="mdl-checkbox__label"></span>
					</label>  Cadence
					<span for="cadsw" class="mdl-tooltip">Display/hide cadence trend.</span>
				</div>
				<div class="mdl-cell mdl-cell--3-col-desktop mdl-cell--2-col-tablet">    
					<label id="metricsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="usemetric">
					<input type="checkbox" id="usemetric" onclick="visualize()" class="mdl-checkbox__input" >
					<span class="mdl-checkbox__label"></span>
					</label> Metric
					<span for="metricsw" class="mdl-tooltip">Replot in metric or english unit system.</span>
				</div>
			</div>
			</div>
			
			<!-- Map -->
			<div class="mdl-card mdl-cell--4-col-desktop mdl-cell--8-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Map</h2>
				</div>
				<div class="google-map" id="mapDiv">
				</div>
			</div>
		</div>

		</div>

		<footer class="mdl-mini-footer">
		<div class="mdl-mini-footer__left-section">
			<div class="mdl-logo">
			More Information
			</div>
			<ul class="mdl-mini-footer__link-list">
			<li><a target="_blank" href="/static/help.html">Help</a></li>
			<li><a target="_blank" href="/static/help.html#license">License</a></li>
			</ul>
		</div>
		<div class="mdl-mini-footer__right-section">
		<!--
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
		-->
		</div>
		</footer>
	</section>
	<section class="mdl-layout__tab-panel" id="fixed-tab-3">
		<div class="page-content"><!-- Your content goes here -->


			<div class="mdl-grid">


			<!-- Analysis -->
			<div class="mdl-card mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Inputs</h2>
				</div>

				<div class="mdl-grid">

						<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
						<div class="mdl-tabs__tab-bar">
							<a href="#race-panel" class="mdl-tabs__tab is-active">Past Race</a>
							<a href="#run-panel" class="mdl-tabs__tab">This Run</a>
						</div>

						<div class="mdl-tabs__panel is-active" id="race-panel">
							<div id="race-txt" class="mdl-card__subtitle-text">
							Enter values for a recent race (required):
							</div>
							<span for="race-txt" class="mdl-tooltip">VO<sub>2</sub>race/max and training paces are calculated from a recent race.</span>
							<form action="#">

							<div mdl-cell--3-col-desktop mdl-cell--4-col-tablet> 
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="racedist" onchange="analyze()" value="5000.0">
								<label class="mdl-textfield__label" for="racedist">Distance(m)</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="racehours" onchange="analyze()" value="0">
								<label class="mdl-textfield__label" for="racehours">Finish time(hr):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="racemins" onchange="analyze()" value="25">
								<label class="mdl-textfield__label" for="racemins">Finish time(min):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="racesecs" onchange="analyze()" value="0">
								<label class="mdl-textfield__label" for="racesecs">Finish time(secs):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
							</div>
						</div>
						<div class="mdl-tabs__panel" id="run-panel">
							<div id="run-txt" class="mdl-card__subtitle-text">
							Calculate results based on the entire run or just a segment:
							</div>
							<span for="run-txt" class="mdl-tooltip">VO<sub>2</sub>run and equivalent performances paces are calculated from this run.</span>
							<div mdl-cell--3-col-desktop mdl-cell--4-col-tablet> 
							<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="calc-1" onclick="disableInputs()" >
							<input type="radio" id="calc-1" class="mdl-radio__button" name="options" value="Entire" onchange="analyze()" checked>
							<span id="calc-1-lbl" class="mdl-radio__label">Entire</span>
							<span for="calc-1-lbl" class="mdl-tooltip">Choose this for workouts where your pace doesn't change much, such as tempo or long runs.</span>
							</label>
							<label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="calc-2" onclick="enableInputs()" >
							<input type="radio" id="calc-2" class="mdl-radio__button" name="options" value="Segment" onchange="analyze()" >
							<span id="calc-2-lbl" class="mdl-radio__label">Segment</span>
							<span for="calc-2-lbl" class="mdl-tooltip">Choose this for workouts where the pace changes, such as interval workouts.</span>
							</label>
							</div> 
							<div mdl-cell--3-col-desktop mdl-cell--4-col-tablet> 
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="splitdisttf">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="splitdist" onchange="analyze()" value="5000.0" disabled>
								<label class="mdl-textfield__label" for="splitdist">Distance(m)</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="splithourstf">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="splithours" onchange="analyze()" value="0" disabled>
								<label class="mdl-textfield__label" for="splithours">Split time(hr):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="splitminstf">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="splitmins" onchange="analyze()" value="25" disabled >
								<label class="mdl-textfield__label" for="splitmins">Split time(min):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
								<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="splitsecstf">
								<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*([0-9]+)?" id="splitsecs" onchange="analyze()" value="0" disabled>
								<label class="mdl-textfield__label" for="splitsecs">Split time(secs):</label>
								<span class="mdl-textfield__error">Input is not a number!</span>
								</div>
							</div>
							</form>
						</div>
						</div>
				</div>
			</div>

			<!-- VO2 Results -->
			<div class="mdl-card mdl-cell--2-col-desktop mdl-cell--4-col-tablet mdl-shadow--3dp">

				<div mdl-cell--3-col-desktop mdl-cell--4-col-tablet> 
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Results</h2>
				</div>
				<div class="mdl-card__subtitle-text">
				What are my results for this run?
				</div>
					<div id="run_support">
					</div> 
					<div id="run_score_div">
					</div>
				<div class="mdl-card__subtitle-text">
					<a target="_blank" href="/static/help.html#interpreting-results">How do I interpet these results?</a>
				</div>
				</div>
			</div>




			<!-- Race performance -->
			<div class="mdl-card mdl-cell--3-col-desktop mdl-cell--4-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Equivalent Performances</h2>
				</div>
				<div class="google-table" id="prediction_div">
				</div>
			</div>

			<!-- Training paces -->
			<div class="mdl-card mdl-cell--3-col-desktop mdl-cell--4-col-tablet mdl-shadow--3dp">
				<div class="mdl-card__title">
					<h2 class="mdl-card__title-text">Training Paces</h2>
				</div>
				<div class="google-table" id="training_div">
				</div>
			</div>


		</div> 

		</div>

		<footer class="mdl-mini-footer">
		<div class="mdl-mini-footer__left-section">
			<div class="mdl-logo">
			More Information
			</div>
			<ul class="mdl-mini-footer__link-list">
			<li><a target="_blank" href="/static/help.html">Help</a></li>
			<li><a target="_blank" href="/static/help.html#license">License</a></li>
			</ul>
		</div>
		<div class="mdl-mini-footer__right-section">
		<!--
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
			<button class="mdl-mini-footer__social-btn"></button>
		-->
		</div>
		</footer>

	</section>
  </main>
</div>





  </body>
</html>

