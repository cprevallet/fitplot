<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>


<!--  Add the JavaScript to initialize the chart on document ready -->
<script>
    var chart; // global
    var map; // global
    var p; //global
    var marker; //global

	
    function hideIt(idx) {
	if (chart.series[idx].visible) {
	    chart.series[idx].hide();
	    chart.yAxis[idx].visible = false;
	    chart.yAxis[idx].setTitle({text: ''});
	} else {
	    chart.series[idx].show();
	    chart.yAxis[idx].visible = true;
	    if (idx == 0) {chart.yAxis[0].setTitle({text: p.Y0Name})};
	    if (idx == 1) {chart.yAxis[1].setTitle({text: p.Y1Name})};
	    if (idx == 2) {chart.yAxis[2].setTitle({text: p.Y2Name})};
	}
	}

    function moveMarker(evnt){
	// undocumented api function, may change?
	// http://jsfiddle.net/highcharts/K7pN9/
	evt = chart.pointer.normalize(evnt); 	
	point = chart.series[0].searchPoint(evt, true);
	if (point) {
		var moveLatlong = p.Latlongs[point.index];
		marker.setPosition(moveLatlong);
		}
	}

    function createEmptyChart() {

	//
	//Here's a chart object with good defaults for a distance chart.
	//

	newChart = new Highcharts.Chart({
	    chart: {
		zoomType: 'xy',
		renderTo: 'rungraph',
		defaultSeriesType: 'spline',
		panning: true,
		panKey: 'shift'
	    },
	    credits: {
		enabled: false
	    },
	    legend: {
		enabled: false
	    },
	    title: {
		text: 'Point plot'
	    },
	    tooltip: {
		shared: true,
		formatter: function () {
		    var s = '<b>' + 'Distance : ' + this.x.toFixed(2) + '</b>';
		    var primaryY = this.points[0];
		    var secondaryY = this.points[1];
		    var tertiaryY = this.points[2];
		    var minutes = primaryY.y;
		    var sign = minutes < 0 ? "-" : "";
		    var min = Math.floor(Math.abs(minutes));
		    var sec = Math.floor((Math.abs(minutes) * 60) % 60);
		    var returnval = sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
		    s += '<br/>' + primaryY.series.name + ' : ' + returnval
		    if (secondaryY) {
			    s += '<br/>' + secondaryY.series.name + ' : ' + secondaryY.y.toFixed(2);
			}
		    if (tertiaryY) {
			    s += '<br/>' + tertiaryY.series.name + ' : ' + tertiaryY.y.toFixed(2);
			}
		    return s;
		}
	    },
	    series: [{
			yAxis: 0,
			color: Highcharts.getOptions().colors[0]
		    }, {
			yAxis: 1,
			color: Highcharts.getOptions().colors[1]
		    }, {
			yAxis: 2,
			color: Highcharts.getOptions().colors[2]
	    }],

	    yAxis: [{ // Primary yAxis
			reversed: true,
			title: {
			    text: 'First axis',
			    style: {
				color: Highcharts.getOptions().colors[0]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[0]
			    },
			    formatter: function (){
					var minutes = this.value
					var sign = minutes < 0 ? "-" : "";
					var min = Math.floor(Math.abs(minutes));
					var sec = Math.floor((Math.abs(minutes) * 60) % 60);
					return sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
					}
			}
		    }, { // Secondary yAxis
			title: {
			    text: 'Second axis',
			    style: {
				color: Highcharts.getOptions().colors[1]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[1]
			    }
			},
			opposite: true
		    }, { // Tertiary yAxis
			title: {
			    text: 'Third axis',
			    style: {
				color: Highcharts.getOptions().colors[2]
			    }
			},
			labels: {
			    style: {
				color: Highcharts.getOptions().colors[2]
			    }
			},
			opposite: true
	    }]
	});
	return newChart;
	} //createEmptyChart

    /**
    * Request data from the server, and populate the graph and chart.
    */
    function requestData() {
	var useEnglish = !$("#usemetric").is(':checked')
	var showPace = $("#pacechk").is(':checked')
	var showElev = $("#elevchk").is(':checked')
	var showCad = $("#cadchk").is(':checked')
	$.ajax({
	    url: '/getplot',
	    data: {toEnglish: useEnglish},
	    dataType: "json",
	    success: function(data) {

		// save a global copy
		p = data

		// create a new chart
		chart = createEmptyChart();

		// add the points
		chart.series[0].setData(eval(p.Y0coordinates));
		chart.series[1].setData(eval(p.Y1coordinates));
		chart.series[2].setData(eval(p.Y2coordinates));
		chart.setTitle({
		    text: p.Titletext
		});
		chart.xAxis[0].setTitle({
		    text: p.XName
		});
		chart.yAxis[0].setTitle({
		    text: p.Y0Name
		});
		chart.yAxis[1].setTitle({
		    text: p.Y1Name
		});
		chart.yAxis[2].setTitle({
		    text: p.Y2Name
		});
		chart.series[0].name = p.Y0Name
		chart.series[1].name = p.Y1Name
		chart.series[2].name = p.Y2Name
	      
		// honor the user's preference on what to show
		if (showPace == false) {hideIt(0);}
		if (showElev == false) {hideIt(1);}
		if (showCad == false) {hideIt(2);}
		
		// create a new map
		map = new google.maps.Map(document.getElementById('map'), {
		  zoom: 15,
		  center: p.Latlongs[0],
		  mapTypeId: google.maps.MapTypeId.TERRAIN
		});               
		
		// https://snazzymaps.com/style/134/light-dream
/*		
		var mapstyles = [{
		      "featureType": "landscape",
		      "stylers": [{
			  "hue": "#FFBB00"
		      }, {
			  "saturation": 43.4
		      }, {
			  "lightness": 37.6
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.highway",
		      "stylers": [{
			  "hue": "#FFC200"
		      }, {
			  "saturation": -61.8
		      }, {
			  "lightness": 45.6
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.arterial",
		      "stylers": [{
			  "hue": "#FF0300"
		      }, {
			  "saturation": -100
		      }, {
			  "lightness": 51.2
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "road.local",
		      "stylers": [{
			  "hue": "#FF0300"
		      }, {
			  "saturation": -100
		      }, {
			  "lightness": 52
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "water",
		      "stylers": [{
			  "hue": "#0078FF"
		      }, {
			  "saturation": -13.2
		      }, {
			  "lightness": 2.4
		      }, {
			  "gamma": 1
		      }]
		  }, {
		      "featureType": "poi",
		      "stylers": [{
			  "hue": "#00FF6A"
		      }, {
			  "saturation": -1.0989010989011
		      }, {
			  "lightness": 11.2
		      }, {
			  "gamma": 1
		      }]
		  }];

		map.setOptions({styles: mapstyles});
*/
		var runPath = new google.maps.Polyline({
		  path: p.Latlongs,
		  geodesic: true,
		  strokeColor: '#ff0000',
//		  strokeOpacity: 0.5,
//		  strokeWeight: 2
		});

		runPath.setMap(map);

		// Center map based on path
		var bound = new google.maps.LatLngBounds();
		for (i = 0; i < p.Latlongs.length; i++) {
		  bound.extend( new google.maps.LatLng(p.Latlongs[i].lat, p.Latlongs[i].lng) );
		}
		map.setCenter(bound.getCenter());
		map.fitBounds(bound);

		marker = new google.maps.Marker({
		    position: p.Latlongs[0],
		    title:"Here we are!"
		});
		marker.setMap(map);

		// Listen to mouse moves over the chart.
		chartDiv = document.getElementById('rungraph');
		google.maps.event.addDomListener(chartDiv, 'mousemove', function(e){
			moveMarker(e);
			});
			
		// Add lap values to the data table.	
		var data = new google.visualization.DataTable();
		data.addColumn('number', p.C0Str);
		data.addColumn('number', p.C1Str);
		data.addColumn('string', p.C2Str);
		data.addColumn('string', p.C3Str);
		data.addColumn('number', p.C4Str);
		var cellStyle = {style: 'font-family: Roboto, serif; font-size: 12px; opacity: 0.; text-align:center; vertical-align:middle'}
		for (i = 0; i < p.LapDist.length; i++) { 
		  data.addRows([[i+1, p.LapDist[i], p.LapPace[i], p.LapTime[i], p.LapCal[i]],]);
		  data.setProperties(i, 0, cellStyle);
		  data.setProperties(i, 1, cellStyle);
		  data.setProperties(i, 2, cellStyle);
		  data.setProperties(i, 3, cellStyle);
		  data.setProperties(i, 4, cellStyle);
		}
		var table = new google.visualization.Table(document.getElementById('table_div'));
		table.draw(data, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});
	
	    },
	    cache: false
	}); 

    } 



	      
    $(document).ready(function() {
	

	
	// Submit the file upload form.
	document.getElementById("runfile").onchange = function() {
	    var file = runfile.files[0]; // grab the first (and only) file in the list
	    var fileExt = $("input#runfile").val();
	    fileExt = fileExt.slice(fileExt.length - 3, fileExt.length);
	    fileExt = fileExt.toLowerCase();

	    // check file formats
	    if (fileExt != "fit" && fileExt != "tcx") {
		alert(fileExt + ' error. Only supports .fit and .tcx files are supported at this time.');
		return false;
	    } // end if file not the right type
	
	    var file = $('#runfile').get(0).files[0];
	    var formData = new FormData();
	    formData.append('file', file)
	    $.ajax({
		url: "",
		type: "post",
		data: formData,
		processData: false,
		contentType: false,
		success: function(){
		  requestData();
		},
		error:function(){
		  alert("Sorry! Error uploading file.");
		}   
	    }); 
	}

	//
	//Here's the global options object...
	//

	/**
	* Grid-light theme for Highcharts JS
	* @author Torstein Honsi
	*/
	// Load the fonts
	
	Highcharts.createElement('link', {
	    href: 'https://fonts.googleapis.com/css?family=Roboto:300,400,500,700',
	    rel: 'stylesheet',
	    type: 'text/css'
	}, null, document.getElementsByTagName('head')[0]);
/*        
	Highcharts.createElement('link', {
	    href: 'https://fonts.googleapis.com/css?family=Dosis:400,600',
	    rel: 'stylesheet',
	    type: 'text/css'
	}, null, document.getElementsByTagName('head')[0]); 
*/
	Highcharts.theme = {

	    colors: ["#70c6ea", "#6de8c3", "#ce7190", "#b28585","#75bedd", "#aaeeee", "#ff0066", "#eeaaee",
		"#55BF3B", "#DF5353", "#7798BF", "#aaeeee"
	    ],
	    chart: {
		backgroundColor: null,
		style: {
		    fontFamily: "Roboto, sans-serif"
		}
	    },
	    title: {
		style: {
		    fontSize: '14px',
//                    textTransform: 'uppercase'
		}
	    },
	    tooltip: {
		borderWidth: 0,
		backgroundColor: 'rgba(219,219,216,0.8)',
		shadow: false
	    },
	    legend: {
		itemStyle: {
		    fontWeight: 'bold',
		    fontSize: '14px'
		}
	    },
	    xAxis: {
		gridLineWidth: 2,
		title: {
		    style: {
//                        textTransform: 'uppercase',
			fontSize: '16px'
		    }
		},
		labels: {
		    style: {
			fontSize: '14px'
		    }
		}
	    },
	    yAxis: {
		minorTickInterval: 'auto',
		title: {
		    style: {
//                        textTransform: 'uppercase',
			fontSize: '14px'
		    }
		},
		labels: {
		    style: {
			fontSize: '14px'
		    }
		}
	    },
	    plotOptions: {
		series: {
		    shadow: false
		},
		candlestick: {
		    lineColor: '#404048'
		}
	    },


	    // General
	    background2: '#F0F0EA'

	};

	// Apply the theme
	Highcharts.setOptions(Highcharts.theme);

    });
    
  

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsay4E0YcVz-1-OdkSnAoTBn7Axtqbw7Y">
</script>


<style>
#runfile { display: none }
</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
google.charts.load('current', {'packages':['table']});
</script>
    
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.blue-green.min.css" />
<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

</head>
  <body>
  
    <div class="mdl-grid">
      <div class="mdl-cell mdl-cell--12-col"></div>
	      <!-- FAB button with ripple -->   
	  <label id="runbtn" for="runfile" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--accent ">
	    <i class="material-icons">directions_run</i>
	    <input type="file" name="runfile" id="runfile"> 
	  </label>
	  <span for="runbtn" class="mdl-tooltip">Load a Garmin .fit or .tcx file</span>
      </div>
    </div>  
  
  
    <div class="mdl-card mdl-cell--12-col mdl-shadow--3dp">
    <div class="mdl-card__title">
      <h2 class="mdl-card__title-text">Graph</h2>
    </div>
    <div id="rungraph">
    </div>
    <div class="mdl-grid">
    <div class="mdl-cell mdl-cell--3-col">    
      <label id="pacesw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="pacechk">
	  <input type="checkbox" id="pacechk" onclick="hideIt(0)" class="mdl-checkbox__input" checked>
	  <span class="mdl-checkbox__label"></span>
      </label> Pace
      <span for="pacesw" class="mdl-tooltip">Display/hide pace trend.</span>
    </div>
    <div class="mdl-cell mdl-cell--3-col">   
    <label id="elevsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="elevchk">
	    <input type="checkbox" id="elevchk" onclick="hideIt(1)" class="mdl-checkbox__input" checked>
	    <span class="mdl-checkbox__label"></span>
	  </label> Elevation
      <span for="elevsw" class="mdl-tooltip">Display/hide elevation trend.</span>
    </div>
    <div class="mdl-cell mdl-cell--3-col">
      <label id="cadsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="cadchk">
	<input type="checkbox" id="cadchk" onclick="hideIt(2)" class="mdl-checkbox__input" checked>
	<span class="mdl-checkbox__label"></span>
      </label>  Cadence
      <span for="cadsw" class="mdl-tooltip">Display/hide cadence trend.</span>
    </div>
    <div class="mdl-cell mdl-cell--3-col">      
      <label id="metricsw" class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="usemetric">
	  <input type="checkbox" id="usemetric" onclick="requestData()" class="mdl-checkbox__input" >
	  <span class="mdl-checkbox__label"></span>
      </label> Metric
      <span for="metricsw" class="mdl-tooltip">Replot in metric or english unit system.</span>
    </div>
  </div>
    <div class="mdl-card__supporting-text">
	  Click and drag = zoom, Shift-drag = pan
    </div>
  </div>
  
  <div class="mdl-grid">
	<div class="mdl-card mdl-cell--6-col mdl-shadow--3dp">
      <div class="mdl-card__title">
	<h2 class="mdl-card__title-text">Map</h2>
      </div>
	<div id="map" style="height: 380px;"></div>
      <div class="mdl-card__actions">
	<a href="https://support.google.com/maps/answer/144349?hl=e">Google Maps Help</a>
      </div>
    </div>
	<div class="mdl-card mdl-cell--6-col mdl-shadow--3dp">
      <div class="mdl-card__title">
	<h2 class="mdl-card__title-text">Laps/Splits</h2>
      </div>
      <div id="table_div" style="height: 380px">
      </div>
    <div class="mdl-card__supporting-text">
	  Click the headers to sort.
    </div>      
    </div>
  </div>
  

  </body>
</html>

