<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.1.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>


<!--  Add the JavaScript to initialize the chart on document ready -->
<script>
    var chart; // global
    var map; // global
    var p; //global
    var marker; //global

    function showHide(idx) {
	if (chart.series[idx].visible) {
	    chart.series[idx].hide();
	    chart.yAxis[idx].visible = false;
	    chart.yAxis[idx].setTitle({text: ''});
	} else {
	    chart.series[idx].show();
	    chart.yAxis[idx].visible = true;
	    if (idx == 0) {chart.yAxis[0].setTitle({text: p.Y0Name})};
	    if (idx == 1) {chart.yAxis[1].setTitle({text: p.Y1Name})};
	    if (idx == 2) {chart.yAxis[2].setTitle({text: p.Y2Name})};
	}
	}

    function moveMarker(evnt){
	// undocumented api function, may change?
	// http://jsfiddle.net/highcharts/K7pN9/
	evt = chart.pointer.normalize(evnt); 	
	point = chart.series[0].searchPoint(evt, true);
	if (point) {
		var moveLatlong = p.Latlongs[point.index];
		marker.setPosition(moveLatlong);
		}
        }


    /**
     * Request data from the server, add it to the graph and set a timeout to request again
     */
    function requestData() {
        $.ajax({
            url: '/getplot',

            success: function(data) {

		// save a global copy
                p = data
                // add the points
                chart.series[0].setData(eval(p.Y0coordinates));
                chart.series[1].setData(eval(p.Y1coordinates));
                chart.series[2].setData(eval(p.Y2coordinates));
                chart.setTitle({
                    text: p.Titletext
                });
                chart.xAxis[0].setTitle({
                    text: p.XName
                });
                chart.yAxis[0].setTitle({
                    text: p.Y0Name
                });
                chart.yAxis[1].setTitle({
                    text: p.Y1Name
                });
                chart.yAxis[2].setTitle({
                    text: p.Y2Name
                });
                chart.series[0].name = p.Y0Name
                chart.series[1].name = p.Y1Name
                chart.series[2].name = p.Y2Name

		map = new google.maps.Map(document.getElementById('map'), {
		  zoom: 15,
		  center: p.Latlongs[0],
		  mapTypeId: google.maps.MapTypeId.TERRAIN
		});

		var runPath = new google.maps.Polyline({
		  path: p.Latlongs,
		  geodesic: true,
		  strokeColor: '#FF0000',
		  strokeOpacity: 1.0,
		  strokeWeight: 2
		});

		runPath.setMap(map);

		// Center map based on path
		var bound = new google.maps.LatLngBounds();
		for (i = 0; i < p.Latlongs.length; i++) {
		  bound.extend( new google.maps.LatLng(p.Latlongs[i].lat, p.Latlongs[i].lng) );
		}
		map.setCenter(bound.getCenter());
		map.fitBounds(bound);

		marker = new google.maps.Marker({
		    position: p.Latlongs[0],
		    title:"Here we are!"
		});
		marker.setMap(map);

		// Listen to mouse moves over the chart.
		chartDiv = document.getElementById('container');
		google.maps.event.addDomListener(chartDiv, 'mousemove', function(e){
			 moveMarker(e);
			});
            },
            cache: false
        }); 

    } 

    $(document).ready(function() {


	//
        //Here's the global options object...
	//

        /**
         * Grid-light theme for Highcharts JS
         * @author Torstein Honsi
         */

        // Load the fonts
        Highcharts.createElement('link', {
            href: 'https://fonts.googleapis.com/css?family=Dosis:400,600',
            rel: 'stylesheet',
            type: 'text/css'
        }, null, document.getElementsByTagName('head')[0]);

        Highcharts.theme = {
            colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
                "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"
            ],
            chart: {
                backgroundColor: null,
                style: {
                    fontFamily: "Dosis, sans-serif"
                }
            },
            title: {
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    textTransform: 'uppercase'
                }
            },
            tooltip: {
                borderWidth: 0,
                backgroundColor: 'rgba(219,219,216,0.8)',
                shadow: false
            },
            legend: {
                itemStyle: {
                    fontWeight: 'bold',
                    fontSize: '13px'
                }
            },
            xAxis: {
                gridLineWidth: 1,
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yAxis: {
                minorTickInterval: 'auto',
                title: {
                    style: {
                        textTransform: 'uppercase'
                    }
                },
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            plotOptions: {
                series: {
                    shadow: true
                },
                candlestick: {
                    lineColor: '#404048'
                }
            },


            // General
            background2: '#F0F0EA'

        };

        // Apply the theme
        Highcharts.setOptions(Highcharts.theme);


	//
        //Here's the chart options object...
	//

        chart = new Highcharts.Chart({
            chart: {
                zoomType: 'xy',
                renderTo: 'container',
                defaultSeriesType: 'spline',
		panning: true,
		panKey: 'shift'
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: false
            },
            title: {
                text: 'Point plot'
            },
            tooltip: {
                shared: true,
		formatter: function () {
		    var s = '<b>' + 'Distance : ' + this.x.toFixed(2) + '</b>';
		    var primaryY = this.points[0];
		    var secondaryY = this.points[1];
		    var tertiaryY = this.points[2];
		    var minutes = primaryY.y;
		    var sign = minutes < 0 ? "-" : "";
		    var min = Math.floor(Math.abs(minutes));
		    var sec = Math.floor((Math.abs(minutes) * 60) % 60);
		    var returnval = sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
		    s += '<br/>' + primaryY.series.name + ' : ' + returnval
		    if (secondaryY) {
			    s += '<br/>' + secondaryY.series.name + ' : ' + secondaryY.y.toFixed(2);
			}
		    if (tertiaryY) {
			    s += '<br/>' + tertiaryY.series.name + ' : ' + tertiaryY.y.toFixed(2);
			}
		    return s;
		}


            },

            series: [{
                yAxis: 0,
		color: Highcharts.getOptions().colors[1]
            }, {
                yAxis: 1,
//		type: "area",
//		fillOpacity: 0.1,
		color: Highcharts.getOptions().colors[3]
            }, {
                yAxis: 2,
		color: Highcharts.getOptions().colors[2]
            }],

            yAxis: [{ // Primary yAxis
                reversed: true,
                title: {
                    text: 'First axis',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    }
                },
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    },
		    formatter: function (){
				 var minutes = this.value
				 var sign = minutes < 0 ? "-" : "";
				 var min = Math.floor(Math.abs(minutes));
				 var sec = Math.floor((Math.abs(minutes) * 60) % 60);
				 return sign + (min < 10 ? "0" : "") + min + ":" + (sec < 10 ? "0" : "") + sec;
				}
		}
            }, { // Secondary yAxis
                title: {
                    text: 'Second axis',
                    style: {
                        color: Highcharts.getOptions().colors[3]
                    }
                },
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[3]
                    }
                },
                opposite: true
            }, { // Tertiary yAxis
                title: {
                    text: 'Third axis',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                labels: {
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                opposite: true
            }]


        });


    });


</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsay4E0YcVz-1-OdkSnAoTBn7Axtqbw7Y">
</script>

</head>
<body>

    <!-- 3. Add the container -->
    <div id="container" style="width: 800px; height: 400px; margin: 0 auto"></div>
    <div>
    <input type="button" onclick="showHide(0)" value="Pace" style="display: block; margin: 0 auto;">
    <input type="button" onclick="showHide(1)" value="Altitude" style="display: block; margin: 0 auto;">
    <input type="button" onclick="showHide(2)" value="Cadence" style="display: block; margin: 0 auto;">
    </div>
    <div id="map" style="width: 800px; height: 400px; margin: 0 auto"></div>
    <div id="container2" style="width: 800px; height: 200px; margin: 0 auto">
    <form class="form-signin" method="post" action="/upload" enctype="multipart/form-data">
          <input type="file" name="myfiles" id="myfiles" multiple="multiple">
          <input type="submit" name="submit" value="Load">
    </form>
    <button onclick="requestData()" id="my-button">Plot</button>
    </div>

  </body>
</html>

